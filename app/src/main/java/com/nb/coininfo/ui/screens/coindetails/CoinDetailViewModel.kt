package com.nb.coininfo.ui.screens.coindetails

import android.util.Log
import androidx.annotation.Keep
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken
import com.nb.coininfo.data.models.CoinDetails
import com.nb.coininfo.data.models.CoinDetailsEntity
import com.nb.coininfo.data.models.EventEntity
import com.nb.coininfo.data.models.MarketChartResponse
import com.nb.coininfo.data.repository.CryptoLocalRepository
import com.nb.coininfo.data.repository.CryptoRepository
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.delay
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.catch
import kotlinx.coroutines.flow.flowOn
import kotlinx.coroutines.flow.update
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import javax.inject.Inject


@Keep
data class CoinDetailsUiState(
    val isLoading: Boolean = true,
    val coin: CoinDetails? = null,
    val graphData: List<Pair<Double, Double>>? = null,
    val coinEvents: List<EventEntity>? = null,
)

sealed class CoinDetailEvents {
    data class GetCoins(val id: String): CoinDetailEvents()
    data class GetGraph(val id: String): CoinDetailEvents()
}



@HiltViewModel
class CoinDetailViewModel @Inject constructor(
    private val cryptoRepository: CryptoRepository,
    private val cryptoLocalRepository: CryptoLocalRepository
): ViewModel() {

    private val _uiState = MutableStateFlow(CoinDetailsUiState(isLoading = true))
    val uiState : StateFlow<CoinDetailsUiState>
        get() = _uiState


    fun getCoinDetails(id: String) {
        viewModelScope.launch {
            cryptoLocalRepository.getCoinDetails(id)
                .flowOn(Dispatchers.IO)
                .catch {
                    Log.d("VM", "coin: ${it.localizedMessage}")
                    _uiState.update {
                        it.copy(isLoading = false)
                    }
                }
                .collect { coinDetails ->
                    if (coinDetails != null) {
                        _uiState.update {
                            it.copy(false, coinDetails.toCoinDetails())
                        }
                        getGraphData(id)
                    } else {
                        getCoinOnline(id)
                    }
                    Log.d("VM", "coin: $coinDetails")
                }
        }
    }

    private fun getCoinOnline(id: String) {
        viewModelScope.launch {
            cryptoRepository.getCoin(id)
                .flowOn(Dispatchers.IO)
                .catch {
                    Log.d("VM", "coin: ${it.localizedMessage}")
                }
                .collect { coinDetails ->
                    coinDetails?.let {
                        withContext(Dispatchers.IO) {
                            cryptoLocalRepository.insertCoinDetails(it)
                        }
                    }
                    _uiState.update {
                        it.copy(false, coinDetails)
                    }
                    if (coinDetails != null) {
                        getGraphData(id)
                    }
                    Log.d("VM", "coin: $coinDetails")
                }
        }
    }

    val chartData : MarketChartResponse = Gson().fromJson(
        """{"prices":[[1758915480620,109195.08820218979],[1758915761559,109128.38013801574],[1758915952387,109130.52548280876],[1758916292714,109191.77134391792],[1758916593065,109258.92293994574],[1758917331791,109256.46837195756],[1758917563157,109268.84084739523],[1758917760615,109329.72071838507],[1758918120903,109173.10640316052],[1758918453241,109168.74307904595],[1758918623919,109196.39555638835],[1758919041557,109260.44345354667],[1758919297149,109243.06208024379],[1758919581441,109232.01948349147],[1758919826585,109260.62948942094],[1758920200836,109350.77400822885],[1758920515438,109302.71576792157],[1758920744631,109260.27265551806],[1758921111839,109260.94999566967],[1758921461638,109402.66061676435],[1758921772588,109391.5420096433],[1758922102386,109478.19451204938],[1758922260610,109498.67299539295],[1758922514161,109476.9400990876],[1758922852013,109470.66774164973],[1758923221584,109378.67530039033],[1758923460605,109415.58066011292],[1758923711962,109475.27268853989],[1758924173949,109520.71047796034],[1758924492444,109411.6901232317],[1758924795384,109544.11135486788],[1758924953785,109562.01015309541],[1758925260661,109574.49308284483],[1758925561432,109536.81509154267],[1758925861465,109546.70048046444],[1758926160938,109558.7526758667],[1758926440601,109594.31711732272],[1758926841920,109607.67495037409],[1758927044102,109638.7646290477],[1758927414290,109613.47250213713],[1758927622079,109611.1798647101],[1758927921499,109548.38129650301],[1758928243879,109535.51614106324],[1758928522254,109532.93650630425],[1758928821881,109507.06926328785],[1758929124157,109586.29266122673],[1758929460730,109600.68016641174],[1758929821502,109686.23867595464],[1758930120585,109701.96484440796],[1758930326721,109701.79195595336],[1758930635479,109706.53724818886],[1758931001933,109710.20874667744],[1758931714100,109660.37389675],[1758931872149,109655.30373573788],[1758932242416,109661.70630567754],[1758932551825,109668.4401484297],[1758932881910,109614.09637923715],[1758933073396,109637.24136130272],[1758933374732,109572.47689621834],[1758933603953,109559.49274926865],[1758933972093,109535.49518976788],[1758934321735,109561.05273061509],[1758934621419,109631.16147182384],[1758934835195,109670.9711899422],[1758935101687,109675.90598450796],[1758935593350,109597.87029424097],[1758935924918,109533.57003753592],[1758936055801,109542.4444677097],[1758936393814,109508.99968198543],[1758936705790,109546.70208457949],[1758936900794,109478.96849271577],[1758937231503,109521.72269692476],[1758937592292,109383.34298689416],[1758937814619,109409.47730461975],[1758938190744,109451.55273652473],[1758938441448,109468.93225169746],[1758938792120,109527.63304050917],[1758939161326,109452.58068195607],[1758939493319,109478.45971947041],[1758939621587,109423.97415562617],[1758939961460,109378.65173780291],[1758940330839,109392.19691125276],[1758940682475,109472.7010805955],[1758940851910,109489.17294206005],[1758941187723,109480.7241295551],[1758941424332,109464.3698898585],[1758941723899,109460.0404524421],[1758942051332,109445.90730953793],[1758942335197,109505.774997863],[1758942636224,109491.87537548937],[1758943054330,109501.49387850486],[1758943381364,109541.2461870314],[1758943542601,109548.36803862281],[1758943861130,109593.93982954783],[1758944126468,109647.99222448745],[1758944462618,109746.18227996337],[1758944787299,109684.53131579614],[1758945141816,109654.8116031144],[1758945451794,109602.17944296282],[1758945760858,109609.75779282032],[1758946044313,109635.3615434116],[1758946362835,109603.29031749317],[1758946572037,109597.13290637125],[1758946912428,109630.47494212756],[1758947281839,109636.2262791756],[1758947481941,109721.18062718918],[1758947831684,109721.27728705682],[1758948182554,109675.73061630421],[1758948332306,109677.86402850325],[1758948696943,109695.05298980747],[1758949040652,109701.63953102907],[1758949381358,109695.63165561004],[1758949581540,109678.54230262176],[1758949920809,109660.27412584446],
            [1758950271511,109679.04208626438],[1758950580791,109678.09962769799],[1758950882104,109647.64862884603],[1758951162458,109658.74994996854],[1758951473262,109694.67453936314],[1758951764280,109725.40953164673],[1758952075322,109701.34127858176],[1758952362527,109672.49923787659],[1758952631820,109686.67328894763],[1758952842818,109681.99331101133],[1758953220607,109667.09960776933],[1758953444208,109617.21641829569],[1758953821809,109623.96895266244],[1758954181260,109599.65859549672],[1758954362173,109576.84406229787],[1758954660889,109591.78227169905],[1758954950824,109575.44009588378],[1758955281851,109574.44150652563],[1758955615746,109534.59283622241],[1758955814438,109556.51286550249],[1758956193185,109569.72107086328],[1758956581576,109600.45255118015],[1758956844135,109599.4271168652],[1758957112307,109587.71777027033],[1758957312950,109603.33926962626],[1758957672131,109613.7367036871],[1758958102100,109563.85981947169],[1758958320957,109544.14970567226],[1758958672774,109479.41015263468],[1758958826006,109473.37672222566],[1758959240924,109409.60460110933],[1758959568188,109426.45989608808],[1758959820685,109450.036932864],[1758960182015,109422.90265091351],[1758960364087,109417.04328746109],[1758960720936,109327.58314265843],[1758960932238,109322.53841214861],[1758961351151,109344.92355517542],[1758961502615,109365.54734609276],[1758961872915,109399.19826260074],[1758962204492,109378.07511999785],[1758962481832,109357.64216998174],[1758962842940,109357.57377779289],[1758963053982,109345.38511708262],[1758963382791,109352.39355701752],[1758963823166,109313.46429620442],[1758964020655,109259.58493114964],[1758964345609,109228.81066569549],[1758964570548,109214.18094931878],[1758964874910,109197.71407724179],[1758965121822,109193.34338654765],[1758965532244,109158.55837767913],[1758965864134,109247.2408379113],[1758966061427,109295.28984782551],[1758966383605,109312.81566792038],[1758966743289,109310.06549386562],[1758966922351,109346.67565617636],[1758967332130,109329.99376052197],[1758967663014,109333.6544756636],[1758967920660,109327.96596201943],[1758968271357,109319.26182702389],[1758968561656,109333.93753505658],[1758968721761,109325.60412831421],[1758969151006,109334.17471426798],[1758969495541,109415.74946094495],[1758969660746,109401.88544352289],[1758970062502,109456.25145230997],[1758970231929,109451.43360176987],[1758970620717,109465.73666021855],[1758970837235,109476.54927693262],[1758971220562,109434.39840262328],[1758971423968,109401.59488036364],[1758971842653,109356.05229420145],[1758972025201,109347.90978318252],[1758972394721,109344.56568509489],[1758972762558,109359.44686723303],[1758972942891,109377.33771318535],[1758973250705,109352.10315055757],[1758973544842,109345.03142884623],[1758973832630,109339.33344451626],[1758974160622,109334.00286036594],[1758974521288,109342.64744553846],[1758974782577,109336.74219306372],[1758975100988,109305.74392558102],[1758975353652,109315.7206303804],[1758975731045,109309.97018351361],[1758976042588,109295.07643742723],[1758976292551,109301.58419991078],[1758976620560,109283.09003600733],[1758976826289,109339.9453184747],[1758977181656,109437.20002955086],[1758977581529,109424.71721232367],[1758977780864,109406.72883075265],[1758978173616,109431.9900852975],[1758978371388,109419.70988071398],[1758978734245,109397.84109932075],[1758978954102,109352.29806772398],[1758979321150,109392.44445931537],[1758979691297,109403.218266457],[1758979886991,109396.29208951659],[1758980176986,109361.69012711667],[1758980408097,109393.30675471986],[1758980772580,109384.87016515847],[1758981201082,109376.9805940801],[1758981462629,109363.34199051761],[1758981685335,109350.69171430042],[1758981984851,109369.79441539408],[1758982361239,109381.83242509364],[1758982661617,109366.90375691591],[1758982843608,109354.496513024],[1758983112017,109363.12671278049],[1758983561507,109360.47612600232],[1758983820771,109375.98993765381],[1758984042531,109373.98142595241],[1758984300722,109350.17852072635],[1758984713782,109310.10780130564],
[1758984922261,109321.29668787651],[1758985364906,109303.9057184713],[1758985633965,109281.92037829466],[1758985939244,109276.44270600633],[1758986220655,109294.91869450161],[1758986481011,109306.27432855577],[1758986723907,109295.58091810952],[1758987141544,109294.15145530773],[1758987360728,109334.73884886612],[1758987657431,109333.45813781007],[1758988032924,109372.11534404145],[1758988320720,109438.08866579965],[1758988620714,109425.46388045549],[1758988823253,109433.85846854272],[1758989342198,109421.98515448018],[1758989425105,109426.07491520095],[1758989881185,109411.69816359848],[1758990092715,109434.02750598059],[1758990352869,109434.85104792991],[1758990722240,109419.16193575835],[1758990976420,109451.01819394728],[1758991381452,109431.52659178169],[1758991561348,109420.86140873906],[1758991822254,109418.53713769466],[1758992262849,109393.83162151331],[1758992520822,109385.55928560787],[1758992880883,109381.46855987459],[1758993031041,109386.02865122691],[1758993376270,109365.27184968411],[1758993781240,109310.79950571903],[1758993994582,109333.76291288335],[1758994213315,109342.19908726355],[1758994621742,109404.98480927321],[1758994921206,109387.52219089172],[1758995272568,109380.08233277495],[1758995552406,109350.3729080568],[1758995774503,109391.31010259358],[1758996042722,109413.47318967037],[1758996432520,109420.49321214826],[1758996713136,109433.20241193379],[1758996925462,109445.89439500228],[1758997271988,109445.60325218223],[1758997741292,109440.67902820447],[1758998033667,109441.59857676433],[1758998163117,109429.68970890965],[1758998454459,109436.91215926064],[1758998812368,109430.96523623966],[1758999023946,109450.79633710322],[1758999333201,109457.15758853668],[1758999962718,109452.83343697815],[1759000065702,109452.05792174363],[1759000322734,109456.24727737052],[1759000621602,109465.21131377787],[1759000828908,109451.62581989841],[1759001221370,109448.58397591667],[1759001561650,109444.03799990761],[1759001951000,109444.10650081551]],"market_caps":[[1758915480620,2176983260198.139],[1758915761559,2175793720184.173],[1758915952387,2175793720184.173],[1758916292714,2174631539574.0251],[1758916593065,2175695904483.919],[1758917331791,2175574569277.963],[1758917563157,2177107828680.457],[1758917760615,2178113646874.7188],[1758918120903,2175618781989.6064],[1758918453241,2175218552279.0872],[1758918623919,2175218552279.0872],[1758919041557,2176613421351.194],[1758919297149,2177448226832.9988],[1758919581441,2176615256053.8594],[1758919826585,2176615256053.8594],[1758920200836,2177850183052.8972],[1758920515438,2179014815581.8152],[1758920744631,2177994488498.1116],[1758921111839,2177233691643.4495],[1758921461638,2180102256785.6602],[1758921772588,2179934392089.227],[1758922102386,2181453156030.0383],[1758922260610,2181453156030.0383],[1758922514161,2181374586766.4126],[1758922852013,2181544524606.6235],[1758923221584,2180616009560.7375],[1758923460605,2179826628254.2412],[1758923711962,2181418073582.373],[1758924173949,2182447344284.023],[1758924492444,2180385424154.9473],[1758924795384,2182662141587.3457],[1758924953785,2182662141587.3457],[1758925260661,2184092599524.638],[1758925561432,2182216625457.5552],[1758925861465,2182830426368.1655],[1758926160938,2182886544075.0613],[1758926440601,2183531883130.5674],[1758926841920,2183956264572.125],[1758927044102,2184680083467.8462],[1758927414290,2184573104682.4287],[1758927622079,2184573104682.4287],[1758927921499,2184056043499.2173],[1758928243879,2182835432210.126],[1758928522254,2182902916503.1309],[1758928821881,2181842927564.437],[1758929124157,2183683684788.2446],[1758929460730,2183683684788.2446],[1758929821502,2184115419336.7249],[1758930120585,2185675119835.141],[1758930326721,2185690816263.7788],[1758930635479,2185726350683.6895],[1758931001933,2185866776171.5464],[1758931714100,2186075315820.048],[1758931872149,2185181205927.3198],[1758932242416,2185181205927.3198],[1758932551825,2185181205927.3198],
[1758932881910,2184386245934.777],[1758933073396,2184386245934.777],[1758933374732,2184304974992.8726],[1758933603953,2183180009178.8872],[1758933972093,2182993294600.5918],[1758934321735,2182819415165.8647],[1758934621419,2184270012532.3547],[1758934835195,2184270012532.3547],[1758935101687,2185734803999.6804],[1758935593350,2183788916763.6343],[1758935924918,2183788916763.6343],[1758936055801,2182838102648.0398],[1758936393814,2182156413294.2642],[1758936705790,2182562439725.5503],[1758936900794,2182562439725.5503],[1758937231503,2181975119077.0417],[1758937592292,2180492888230.0598],[1758937814619,2179919799865.6755],[1758938190744,2180526168399.53],[1758938441448,2181200684881.4185],[1758938792120,2182143607434.7517],[1758939161326,2181777422035.1963],[1758939493319,2182021142800.987],[1758939621587,2182021142800.987],[1758939961460,2180242965895.0503],[1758940330839,2179401490717.394],[1758940682475,2180049064162.6362],[1758940851910,2181299005824.2314],[1758941187723,2181716609521.2065],[1758941424332,2181716609521.2065],[1758941723899,2180981081011.4546],[1758942051332,2181124047015.004],[1758942335197,2181604261111.2312],[1758942636224,2181604261111.2312],[1758943054330,2181914629272.6023],[1758943381364,2182593039380.521],[1758943542601,2182593039380.521],[1758943861130,2183316715519.7754],[1758944126468,2183901825839.5347],[1758944462618,2185062976284.6277],[1758944787299,2186384730064.7993],[1758945141816,2185766224308.0977],[1758945451794,2184545989078.2654],[1758945760858,2183656636270.5867],[1758946044313,2184425573803.8286],[1758946362835,2184607621631.3193],[1758946572037,2183911581165.4492],[1758946912428,2184383564541.1653],[1758947281839,2184433394153.469],[1758947481941,2185024446313.428],[1758947831684,2186665339210.3481],[1758948182554,2185742419871.9526],[1758948332306,2185552968555.2256],[1758948696943,2185444232175.7837],[1758949040652,2185945311398.1648],[1758949381358,2185910723008.57],[1758949581540,2185575758267.578],[1758949920809,2185121379145.5015],[1758950271511,2185159319306.3142],[1758950580791,2185668978956.337],[1758950882104,2185185453620.1106],[1758951162458,2185010788681.3591],[1758951473262,2185303427675.3376],[1758951764280,2186075924771.731],[1758952075322,2186116505333.296],[1758952362527,2185514866187.0327],[1758952631820,2185830504043.3462],[1758952842818,2185830504043.3462],[1758953220607,2185603428436.322],[1758953444208,2185603428436.322],[1758953821809,2185603428436.322],[1758954181260,2183967535904.9373],[1758954362173,2183582588527.207],[1758954660889,2183582588527.207],[1758954950824,2183805636363.3682],[1758955281851,2183398429606.4507],[1758955615746,2182666309302.217],[1758955814438,2182666309302.217],[1758956193185,2183056558406.7656],[1758956581576,2183783827593.7473],[1758956844135,2183939762203.7751],[1758957112307,2183726133634.9026],[1758957312950,2183726133634.9026],[1758957672131,2183967126475.893],[1758958102100,2183331138238.5596],[1758958320957,2183331138238.5596],[1758958672774,2181537273870.2573],[1758958826006,2181537273870.2573],[1758959240924,2180824878199.7708],[1758959568188,2180335195793.092],[1758959820685,2180335195793.092],[1758960182015,2180447403415.4236],[1758960364087,2180447403415.4236],[1758960720936,2178482832386.4502],[1758960932238,2178482832386.4502],[1758961351151,2178815754652.8945],[1758961502615,2178815754652.8945],[1758961872915,2179208579336.198],[1758962204492,2179374844012.841],[1758962481832,2179374844012.841],[1758962842940,2179109348666.2375],[1758963053982,2179109348666.2375],[1758963382791,2178490348946.8918],[1758963823166,2178186899401.8882],[1758964020655,2178186899401.8882],[1758964345609,2176989211233.2456],[1758964570548,2176533113966.9932],[1758964874910,2176275504483.0635],[1758965121822,2175990537266.158],[1758965532244,2175514709154.5898],[1758965864134,2176597403439.5156],[1758966061427,2176597403439.5156],[1758966383605,2178293874765.623],[1758966743289,2178310459428.9941],[1758966922351,2178194905292.3923],
[1758967332130,2179182307695.1145],[1758967663014,2178394242552.6697],[1758967920660,2178693867639.512],[1758968271357,2178692165410.7183],[1758968561656,2178436933555.9382],[1758968721761,2178436933555.9382],[1758969151006,2178801879256.9314],[1758969495541,2180145104886.165],[1758969660746,2180145104886.165],[1758970062502,2180931580087.2104],[1758970231929,2180931580087.2104],[1758970620717,2181317335088.5955],[1758970837235,2181317335088.5955],[1758971220562,2180686725755.405],[1758971423968,2180686725755.405],[1758971842653,2179178925362.5706],[1758972025201,2179178925362.5706],[1758972394721,2179236928260.447],[1758972762558,2179473494474.7202],[1758972942891,2179473494474.7202],[1758973250705,2179462495984.452],[1758973544842,2179174865881.6091],[1758973832630,2178818068610.4214],[1758974160622,2178751745766.7305],[1758974521288,2178902101624.8494],[1758974782577,2178902101624.8494],[1758975100988,2178902101624.8494],[1758975353652,2178902101624.8494],[1758975731045,2178347043345.7603],[1758976042588,2177969104468.003],[1758976292551,2177895800106.7566],[1758976620560,2177740030208.8916],[1758976826289,2177960532945.306],[1758977181656,2180920562347.1667],[1758977581529,2180866378930.0613],[1758977780864,2180270154108.538],[1758978173616,2180870048353.01],[1758978371388,2181011933724.7852],[1758978734245,2179863323481.4358],[1758978954102,2179478414813.572],[1758979321150,2179930069176.6816],[1758979691297,2179578469248.5935],[1758979886991,2180036642170.342],[1758980176986,2179428836939.1572],[1758980408097,2179809280859.524],[1758980772580,2179741995368.5244],[1758981201082,2179810433078.9543],[1758981462629,2179428788829.2634],[1758981685335,2179287423271.8706],[1758981984851,2179161288715.1394],[1758982361239,2179411139139.5225],[1758982661617,2180102322226.7136],[1758982843608,2179208938875.3438],[1758983112017,2179208938875.3438],[1758983561507,2179230743838.898],[1758983820771,2179530346962.0747],[1758984042531,2179530346962.0747],[1758984300722,2179521450452.3235],[1758984713782,2178151423311.6895],[1758984922261,2178151423311.6895],[1758985364906,2178356479369.1267],[1758985633965,2177614921361.7788],[1758985939244,2177497367869.335],[1758986220655,2177925295298.0884],[1758986481011,2177925295298.0884],[1758986723907,2178617644220.921],[1758987141544,2178033501117.8547],[1758987360728,2178033501117.8547],[1758987657431,2178586454770.1482],[1758988032924,2179429184286.924],[1758988320720,2180769092274.6096],[1758988620714,2180769092274.6096],[1758988823253,2180488333514.4604],[1758989342198,2180453896438.8643],[1758989425105,2180453896438.8643],[1758989881185,2180189434769.9475],[1758990092715,2179807137268.7937],[1758990352869,2180550743491.4822],[1758990722240,2180521699319.5713],[1758990976420,2180515144343.682],[1758991381452,2181147349600.4988],[1758991561348,2180637052589.6975],[1758991822254,2180433621237.0752],[1758992262849,2179699155373.459],[1758992520822,2179967391533.375],[1758992880883,2179550164912.4739],[1758993031041,2179626399949.2026],[1758993376270,2179818071992.803],[1758993781240,2179054959426.4807],[1758993994582,2178470523987.6487],[1758994213315,2178316562376.8247],[1758994621742,2179532457856.306],[1758994921206,2179210339562.3953],[1758995272568,2179815008593.4233],[1758995552406,2179574030771.22],[1758995774503,2179393819939.6443],[1758996042722,2180370991547.7986],[1758996432520,2180986751020.5894],[1758996713136,2180986751020.5894],[1758996925462,2180986751020.5894],[1758997271988,2180986751020.5894],[1758997741292,2180921885782.0837],[1758998033667,2180873433552.7827],[1758998163117,2180604839996.0503],[1758998454459,2180604839996.0503],[1758998812368,2180631500848.338],[1758999023946,2180631500848.338],[1758999333201,2181088293752.6377],[1758999962718,2181196856615.7458],[1759000065702,2181095346904.7937],[1759000322734,2181121188312.724],[1759000621602,2181305595692.649],[1759000828908,2181305595692.649],[1759001221370,2181234811753.569],[1759001561650,2181118545316.8894],[1759001951000,2180953835042.6807]],
"total_volumes":[[1758915480620,60031828527.65068],[1758915761559,60025007769.16538],[1758915952387,59971273566.29473],[1758916292714,59988180310.29277],[1758916593065,59898483359.67166],[1758917331791,59422059996.07868],[1758917563157,59772346900.709915],[1758917760615,59764912969.38256],[1758918120903,59913085171.06415],[1758918453241,59918004858.95558],[1758918623919,59258689166.08303],[1758919041557,59258022689.318245],[1758919297149,59696187952.59422],[1758919581441,58875974937.2543],[1758919826585,59014558201.571495],[1758920200836,58639913790.37366],[1758920515438,59455391690.73445],[1758920744631,59267536859.07863],[1758921111839,59038513154.557945],[1758921461638,59155595289.00563],[1758921772588,58555270715.113106],[1758922102386,59057612967.907715],[1758922260610,58587331444.51792],[1758922514161,58444660131.89364],[1758922852013,58456049568.8176],[1758923221584,58777446614.49549],[1758923460605,58547075036.89391],[1758923711962,59373860813.326645],[1758924173949,58203847644.25791],[1758924492444,58592465915.14656],[1758924795384,58613920817.307915],[1758924953785,58538314768.037224],[1758925260661,58623332263.16722],[1758925561432,58088807640.70186],[1758925861465,58039881332.405754],[1758926160938,58397156690.13289],[1758926440601,57868237349.798775],[1758926841920,57575655406.584724],[1758927044102,57938449753.50082],[1758927414290,57847696342.62636],[1758927622079,57986955379.576836],[1758927921499,57809490807.785194],[1758928243879,57199701935.756744],[1758928522254,57414749405.23995],[1758928821881,57362074394.50444],[1758929124157,57836380969.39381],[1758929460730,57008970896.50284],[1758929821502,56759631648.49738],[1758930120585,56120784865.08142],[1758930326721,56332330852.681496],[1758930635479,55652254091.12626],[1758931001933,55257214020.568245],[1758931714100,55614979705.47469],[1758931872149,55517213955.32903],[1758932242416,54781226860.76438],[1758932551825,55210063757.2423],[1758932881910,55218649749.7478],[1758933073396,54790518610.29817],[1758933374732,55069207616.71249],[1758933603953,54753905468.3422],[1758933972093,54583051589.70053],[1758934321735,54387030358.80277],[1758934621419,53694012098.34673],[1758934835195,53614142846.02244],[1758935101687,53700015878.35208],[1758935593350,54156580760.87142],[1758935924918,53541298737.83791],[1758936055801,53449248983.33609],[1758936393814,53053981947.65995],[1758936705790,53396192034.30895],[1758936900794,53387947872.58201],[1758937231503,53050891093.00634],[1758937592292,53304072721.638176],[1758937814619,53289897795.23788],[1758938190744,53200140073.74191],[1758938441448,53092771923.48507],[1758938792120,52969347363.38822],[1758939161326,52882101437.54365],[1758939493319,52667242355.33174],[1758939621587,52642736419.10043],[1758939961460,51793415855.85636],[1758940330839,52021502265.500786],[1758940682475,52176936785.9904],[1758940851910,51927934259.60638],[1758941187723,51654807231.72859],[1758941424332,51871164818.05175],[1758941723899,51799559425.11664],[1758942051332,51761616934.93429],[1758942335197,51924192080.82227],[1758942636224,51643058760.375275],[1758943054330,50950882330.477356],[1758943381364,51673031049.30076],[1758943542601,51327273690.59472],[1758943861130,51170867871.130325],[1758944126468,51281455039.658966],[1758944462618,51642626528.171486],[1758944787299,51203515692.916435],[1758945141816,51236801545.80858],[1758945451794,51579151851.34674],[1758945760858,51465834917.08056],[1758946044313,51079411183.32439],[1758946362835,51227748251.42109],[1758946572037,50969454438.49541],[1758946912428,50950191812.51788],[1758947281839,51335222290.70953],[1758947481941,51422471890.04733],[1758947831684,51288363195.873436],[1758948182554,51338646806.225365],[1758948332306,51347923412.87202],[1758948696943,51373783063.119705],[1758949040652,51224956248.59843],[1758949381358,50811889181.94555],[1758949581540,50671088175.573425],[1758949920809,50690709306.75032],[1758950271511,50454546619.08322],[1758950580791,50866553603.75592],
[1758950882104,50432068435.207535],[1758951162458,50467617941.58275],[1758951473262,50439574803.504845],[1758951764280,50534329601.52763],[1758952075322,50381284386.05306],[1758952362527,50520989992.22563],[1758952631820,49920495026.9449],[1758952842818,49596696622.889244],[1758953220607,50172104510.222626],[1758953444208,50149429599.59289],[1758953821809,49834144388.68429],[1758954181260,49123338808.429115],[1758954362173,49027165162.25963],[1758954660889,48926271092.63051],[1758954950824,48870389465.01787],[1758955281851,49223281116.109634],[1758955615746,48630965068.290924],[1758955814438,48694359060.934425],[1758956193185,48580994828.05839],[1758956581576,48130877926.28814],[1758956844135,47966251262.35949],[1758957112307,47668600331.86233],[1758957312950,47798056889.64927],[1758957672131,47682634141.31851],[1758958102100,48013842081.52423],[1758958320957,47817830262.61488],[1758958672774,46508489863.559654],[1758958826006,46436198823.976036],[1758959240924,45753050239.81017],[1758959568188,44938937922.31059],[1758959820685,44404930593.170975],[1758960182015,44035898953.569565],[1758960364087,43998581024.752],[1758960720936,44022148239.792564],[1758960932238,43832513714.323135],[1758961351151,44098743494.50803],[1758961502615,44115513183.80409],[1758961872915,43868507087.18328],[1758962204492,43305467502.070206],[1758962481832,43738003699.455826],[1758962842940,43322058817.463036],[1758963053982,43715318957.26711],[1758963382791,43736951749.29123],[1758963823166,43320257088.00075],[1758964020655,43603170427.997475],[1758964345609,43292256290.98611],[1758964570548,43202272838.061195],[1758964874910,43178544776.14929],[1758965121822,43111767396.18827],[1758965532244,43427000561.87782],[1758965864134,43415407129.47503],[1758966061427,43440833648.560936],[1758966383605,43338338612.729904],[1758966743289,43596215008.839485],[1758966922351,42754413391.27742],[1758967332130,43137515315.53113],[1758967663014,43115138136.68449],[1758967920660,42897175034.630104],[1758968271357,42725795281.782524],[1758968561656,42509699077.0898],[1758968721761,42522519099.85168],[1758969151006,42482956696.46428],[1758969495541,42766894942.875145],[1758969660746,42321219159.16142],[1758970062502,41591662544.32892],[1758970231929,41683851615.62707],[1758970620717,42131915482.111664],[1758970837235,41394515509.02962],[1758971220562,41477540104.808685],[1758971423968,41360771140.6138],[1758971842653,41245108467.65946],[1758972025201,41068155397.57638],[1758972394721,40841468638.98208],[1758972762558,39871113230.33193],[1758972942891,39789472418.92568],[1758973250705,40079871209.47293],[1758973544842,39767746129.43933],[1758973832630,39769150450.873116],[1758974160622,39856124785.491394],[1758974521288,39703338738.197975],[1758974782577,39359862371.72274],[1758975100988,39624743150.73821],[1758975353652,39579813735.598724],[1758975731045,39287223914.51688],[1758976042588,39046029318.16457],[1758976292551,38930459334.79328],[1758976620560,38337740848.760544],[1758976826289,38481005272.53961],[1758977181656,38469390693.166435],[1758977581529,38042061127.50004],[1758977780864,37882514621.88309],[1758978173616,37982529509.92311],[1758978371388,37552027744.14717],[1758978734245,37374693851.42711],[1758978954102,37455456618.449104],[1758979321150,37480063346.43699],[1758979691297,37315407980.643425],[1758979886991,37284654273.834625],[1758980176986,37135961917.65946],[1758980408097,36748972647.50232],[1758980772580,36524512242.47958],[1758981201082,35767214064.23636],[1758981462629,35230648461.18844],[1758981685335,34916126516.01293],[1758981984851,34730841361.6558],[1758982361239,34568981060.36565],[1758982661617,34292140970.526352],[1758982843608,33880602280.03296],[1758983112017,33864925655.1949],[1758983561507,33457708781.862946],[1758983820771,33290743220.48415],[1758984042531,32895536724.68301],[1758984300722,32738627294.966255],[1758984713782,32437061031.013687],[1758984922261,32363484074.133545],[1758985364906,32017507240.66069],[1758985633965,31971005755.71513],
[1758985939244,31566147390.720203],[1758986220655,31590180862.314465],[1758986481011,31336600688.219566],[1758986723907,31289964561.009094],[1758987141544,31215047050.38693],[1758987360728,31423142565.27915],[1758987657431,31032121526.55981],[1758988032924,31056315843.220985],[1758988320720,31017438698.33004],[1758988620714,31024981852.00064],[1758988823253,30907886951.27576],[1758989342198,31048729506.74243],[1758989425105,31044173738.77013],[1758989881185,31085065166.158497],[1758990092715,31041629998.07163],[1758990352869,30748082167.665577],[1758990722240,30674224308.5745],[1758990976420,30653193812.043774],[1758991381452,30113147021.003704],[1758991561348,30457307952.54941],[1758991822254,30193853594.38414],[1758992262849,30187043001.157524],[1758992520822,30319947618.35997],[1758992880883,30239860024.891003],[1758993031041,30245988175.85725],[1758993376270,29728829279.881626],[1758993781240,29622523628.769352],[1758993994582,29928867699.92081],[1758994213315,29431419076.086296],[1758994621742,29322515602.175583],[1758994921206,29054564420.75233],[1758995272568,28734241866.06366],[1758995552406,28586179586.972782],[1758995774503,28678799681.807777],[1758996042722,28607589246.180046],[1758996432520,28424622718.792126],[1758996713136,28359579019.529522],[1758996925462,28087406458.71768],[1758997271988,28012589601.875473],[1758997741292,27639369111.639145],[1758998033667,27727795849.991592],[1758998163117,27405415002.298195],[1758998454459,27356784586.147797],[1758998812368,27015236971.900665],[1758999023946,26974790072.079372],[1758999333201,26955976966.877247],[1758999962718,26736936950.950115],[1759000065702,26389055935.402],[1759000322734,26138835837.59393],[1759000621602,26205364052.59996],[1759000828908,25909197828.873135],[1759001221370,26088661554.643753],[1759001561650,25921462330.118145],[1759001951000,25344398180.558052]]}
""",
        object : TypeToken<MarketChartResponse>(){}.type)

    fun getGraphData(id: String) {
        viewModelScope.launch {
            delay(1000)
            val processedData = chartData.prices?.map { Pair(it?.get(0) ?: 0.0, it?.get(1) ?: 0.0) }

            _uiState.update {
                it.copy(false, graphData = processedData)
            }
            return@launch
            cryptoRepository.getChartData(id)
                .flowOn(Dispatchers.IO)
                .catch {
                    Log.d("VM", "coin: ${it.localizedMessage}")
                }
                .collect { graphData->
                    val processedData = graphData.prices?.map { Pair(it?.get(0) ?: 0.0, it?.get(1) ?: 0.0) }
                    _uiState.update {
                        it.copy(false, graphData = processedData)
                    }
                    Log.d("VM", "coin: $graphData")
                }
        }
    }


    suspend fun getEvents(coinId: String) {
        cryptoRepository.getEvents(coinId)
            .flowOn(Dispatchers.IO)
            .catch {
                Log.d("VM", "getGlobalStats: ${it.localizedMessage}")
            }
            .collect { ls->
                _uiState.update {
                    it.copy(isLoading = false, coinEvents = ls)
                }
            }
    }

    fun onEvent(event: CoinDetailEvents) {
        when(event) {
            is CoinDetailEvents.GetCoins -> {
                getCoinDetails(event.id)
            }
            is CoinDetailEvents.GetGraph -> {
                getGraphData(event.id)
            }

        }
    }
}